<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DR.URCW AI Assistant</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="/static/styles.css" rel="stylesheet">

</head>

<body>

<div class="wrapper">

    <!-- ================= SIDEBAR ================= -->

    <div class="sidebar">

        <img src="/static/Images_ss/college_logo.png" width="70">
        <h5>DR.URCW AI</h5>
        <small>{{ user.name }}</small>

        <a href="/chatbot" class="btn btn-light btn-sm mt-3">+ New Chat</a>

        <!-- Chat List -->
        <div class="chat-list mt-3">

            {% for s in sessions %}
            <div class="chat-actions">
                <a href="/chatbot?session_id={{ s.id }}"
                   class="{% if s.id == active_session %}active-chat{% endif %}">
                    {{ s.title }}
                </a>

                <div>
                    <a href="/delete_chat/{{ s.id }}"
                       onclick="return confirm('Delete this chat?')"
                       style="color:#ff6b6b; text-decoration:none;">
                        ðŸ—‘
                    </a>
                </div>
            </div>
            {% endfor %}

        </div>

        <div class="mt-auto">
            <a href="/dashboard" class="btn btn-outline-light btn-sm w-100">Dashboard</a>
            <a href="/logout" class="btn btn-outline-light btn-sm w-100 mt-2">Logout</a>
        </div>

    </div>

    <!-- ================= CHAT AREA ================= -->

    <div class="chat-area">

        <div class="chat-header">
            <span>AI Assistant</span>
            <button onclick="toggleMode()" class="btn btn-sm btn-secondary">ðŸŒ™</button>
        </div>

        <div class="chat-body" id="chatBody">

            {% for msg in messages %}
            <div class="message {{ msg.sender }}">
                {{ msg.message | safe }}
            </div>
            {% endfor %}

        </div>

        <form class="chat-input" id="chatForm">
            <input id="msg" placeholder="Ask about DR.URCW..." required>
            <button type="submit">Send</button>
        </form>

    </div>

</div>

<script>

function toggleMode(){
    document.body.classList.toggle("dark");
}

function scrollBottom(){
    let chat = document.getElementById("chatBody");
    chat.scrollTop = chat.scrollHeight;
}

scrollBottom();

document.getElementById("chatForm").addEventListener("submit", function(e){
    e.preventDefault();

    let msgInput = document.getElementById("msg");
    let msg = msgInput.value.trim();
    if(!msg) return;

    let chatBody = document.getElementById("chatBody");

    chatBody.innerHTML += `
        <div class="message user">${msg}</div>
    `;

    msgInput.value="";
    scrollBottom();

    chatBody.innerHTML += `<div id="typing" class="message bot">AI is typing...</div>`;
    scrollBottom();

    fetch("/chat",{
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body:"message="+encodeURIComponent(msg)
    })
    .then(res=>res.json())
    .then(data=>{
        document.getElementById("typing").remove();
        chatBody.innerHTML += `
            <div class="message bot">${data.reply || "Sorry, something went wrong."}</div>
        `;
        scrollBottom();
    });
});

</script>

</body>
</html>
